name: semver workflow
on:
  workflow_dispatch:
    inputs:
      release:
        description: 'Release'
        required: true
        default: 'PATCH'
        type: choice
        options:
          - "PATCH"
          - "MINOR"
          - "MAJOR"

jobs:
  VersionImage:
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check latest Commit Tag
        id: latest_tag
        run: |
          LATEST_TAG=$(git tag --points-at HEAD)
          if [[ -n "$LATEST_TAG" ]]; then
            echo "The tag already exists"
            exit 1
          else
            echo "Latest Tag - $LATEST_TAG"
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

  NewVersionTag:
    runs-on: ubuntu-latest
    continue-on-error: false
    needs:
      - VersionImage
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get Latest Tag
        id: version_tag
        uses: ./.github/actions/semver
        with:
          release: ${{ github.event.inputs.release }}
      - name: Set Version Tag
        id: new_tag
        run: |
          NEW_TAG=${{ steps.version_tag.outputs.version_tag }}
          echo "Latest Tag - $NEW_TAG"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
    outputs:
      version_tag: ${{ steps.new_tag.outputs.new_tag }}

  PushTag:
    permissions:
      contents: write
    continue-on-error: false
    needs:
      - NewVersionTag
    runs-on: ubuntu-latest
    steps:
      - name: Push Latest Tag
        id: create_tag
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/${{needs.VersionImage.outputs.version_tag}}',
              sha: context.sha
            })
